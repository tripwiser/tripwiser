import { Share, Alert, Linking } from 'react-native';
import * as FileSystem from 'expo-file-system';
import * as Sharing from 'expo-sharing';
import { Trip, PackingItem } from '../types';

export interface ShareOptions {
  includePackedItems?: boolean;
  includeNotes?: boolean;
  format: 'text' | 'pdf' | 'link';
  customEmojis?: Record<string, string>; // Add this line
}

export const generatePackingListText = (trip: Trip, options: ShareOptions = { format: 'text' }): string => {
  const { includePackedItems = true, includeNotes = false, customEmojis = {} } = options;
  
  let content = `ğŸ§³ ${trip.name} - Packing List\n`;
  content += `ğŸ“ ${trip.destination}\n`;
  content += `ğŸ“… ${new Date(trip.startDate).toLocaleDateString()} - ${new Date(trip.endDate).toLocaleDateString()}\n`;
  content += `ğŸ‘¥ ${trip.travelers} traveler${trip.travelers > 1 ? 's' : ''}\n\n`;
  
  // Group items by category
  const categories = trip.packingList.reduce((acc, item) => {
    if (!acc[item.category]) {
      acc[item.category] = [];
    }
    acc[item.category].push(item);
    return acc;
  }, {} as Record<string, PackingItem[]>);
  
  Object.entries(categories).forEach(([category, items]) => {
    content += `${getSmartIcon(category, customEmojis)} ${category.toUpperCase()}\n`;
    
    items.forEach(item => {
      if (!includePackedItems && item.packed) return;
      
      const status = item.packed ? 'âœ…' : 'â¬œ';
      const priority = item.essential ? ' â­' : '';
      const assignment = item.assignedTo ? ` (${item.assignedTo})` : '';
      
      content += `${status} ${item.name}${priority}${assignment}\n`;
      
      if (includeNotes && item.notes) {
        content += `   ğŸ’¬ ${item.notes}\n`;
      }
    });
    
    content += '\n';
  });
  
  // Add statistics
  const totalItems = trip.packingList.length;
  const packedItems = trip.packingList.filter(item => item.packed).length;
  const essentialItems = trip.packingList.filter(item => item.essential).length;
  
  content += `ğŸ“Š STATISTICS\n`;
  content += `â€¢ Total items: ${totalItems}\n`;
  content += `â€¢ Packed: ${packedItems}/${totalItems} (${Math.round((packedItems/totalItems) * 100)}%)\n`;
  content += `â€¢ Essential items: ${essentialItems}\n\n`;
  
  content += `Generated by TripWiser ğŸš€`;
  
  return content;
};

export const sharePackingList = async (trip: Trip, options: ShareOptions = { format: 'text' }): Promise<void> => {
  try {
    const content = generatePackingListText(trip, options);
    
    if (options.format === 'text') {
      await Share.share({
        message: content,
        title: `${trip.name} - Packing List`,
      });
    } else if (options.format === 'link') {
      // Generate a shareable link (in a real app, this would upload to a server)
      const shareableLink = `https://tripkit.app/shared-list/${trip.id}`;
      await Share.share({
        message: `Check out my packing list for ${trip.name}!\n\n${shareableLink}\n\nCreated with TripKit`,
        title: `${trip.name} - Packing List`,
      });
    } else if (options.format === 'pdf') {
      // For PDF generation, we'd need a more complex solution
      // For now, we'll just share as text with a note about PDF feature
      Alert.alert(
        'PDF Export',
        'PDF export is coming soon! For now, sharing as text.',
        [
          { text: 'OK', onPress: () => sharePackingList(trip, { ...options, format: 'text' }) }
        ]
      );
    }
  } catch (error) {
    console.error('Error sharing packing list:', error);
    Alert.alert('Error', 'Failed to share packing list');
  }
};

export const generatePackingListHTML = (trip: Trip, options: ShareOptions = { format: 'text' }): string => {
  const { includePackedItems = true, includeNotes = false, customEmojis = {} } = options;
  
  let html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>${trip.name} - Packing List</title>
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; }
        .header { border-bottom: 2px solid #4F46E5; padding-bottom: 20px; margin-bottom: 30px; }
        .title { font-size: 28px; font-weight: bold; color: #1F2937; margin: 0; }
        .subtitle { color: #6B7280; margin: 10px 0; }
        .category { font-size: 20px; font-weight: bold; color: #4F46E5; margin: 25px 0 15px 0; }
        .item { margin: 8px 0; padding: 8px; border-radius: 6px; }
        .item.packed { background-color: #F0FDF4; }
        .item.unpacked { background-color: #FFFBEB; }
        .essential { color: #EA580C; font-weight: bold; }
        .assigned { color: #2563EB; font-size: 14px; }
        .notes { color: #6B7280; font-style: italic; margin-left: 20px; }
        .stats { background-color: #F9FAFB; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .footer { text-align: center; color: #9CA3AF; margin-top: 30px; font-size: 14px; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1 class="title">ğŸ§³ ${trip.name}</h1>
        <div class="subtitle">
          ğŸ“ ${trip.destination}<br>
          ğŸ“… ${new Date(trip.startDate).toLocaleDateString()} - ${new Date(trip.endDate).toLocaleDateString()}<br>
          ğŸ‘¥ ${trip.travelers} traveler${trip.travelers > 1 ? 's' : ''}
        </div>
      </div>
  `;
  
  // Group items by category
  const categories = trip.packingList.reduce((acc, item) => {
    if (!acc[item.category]) {
      acc[item.category] = [];
    }
    acc[item.category].push(item);
    return acc;
  }, {} as Record<string, PackingItem[]>);
  
  Object.entries(categories).forEach(([category, items]) => {
    html += `<div class=\"category\">${getSmartIcon(category, customEmojis)} ${category.toUpperCase()}</div>`;
    
    items.forEach(item => {
      if (!includePackedItems && item.packed) return;
      
      const status = item.packed ? 'âœ…' : 'â¬œ';
      const itemClass = item.packed ? 'packed' : 'unpacked';
      const priority = item.essential ? ' <span class="essential">â­ Essential</span>' : '';
      const assignment = item.assignedTo ? ` <span class="assigned">(${item.assignedTo})</span>` : '';
      
      html += `<div class="item ${itemClass}">${status} ${item.name}${priority}${assignment}</div>`;
      
      if (includeNotes && item.notes) {
        html += `<div class="notes">ğŸ’¬ ${item.notes}</div>`;
      }
    });
  });
  
  // Add statistics
  const totalItems = trip.packingList.length;
  const packedItems = trip.packingList.filter(item => item.packed).length;
  const essentialItems = trip.packingList.filter(item => item.essential).length;
  
  html += `
    <div class="stats">
      <div class="category">ğŸ“Š STATISTICS</div>
      <div>â€¢ Total items: ${totalItems}</div>
      <div>â€¢ Packed: ${packedItems}/${totalItems} (${Math.round((packedItems/totalItems) * 100)}%)</div>
      <div>â€¢ Essential items: ${essentialItems}</div>
    </div>
    
    <div class="footer">
      Generated by TripKit ğŸš€
    </div>
    
    </body>
    </html>
  `;
  
  return html;
};

export const exportPackingListHTML = async (trip: Trip, options: ShareOptions = { format: 'text' }): Promise<void> => {
  try {
    const html = generatePackingListHTML(trip, options);
    const fileName = `${trip.name.replace(/[^a-zA-Z0-9]/g, '_')}_packing_list.html`;
    const fileUri = FileSystem.documentDirectory + fileName;
    
    await FileSystem.writeAsStringAsync(fileUri, html);
    
    if (await Sharing.isAvailableAsync()) {
      await Sharing.shareAsync(fileUri, {
        mimeType: 'text/html',
        dialogTitle: `Share ${trip.name} Packing List`,
      });
    } else {
      Alert.alert('Error', 'Sharing is not available on this device');
    }
  } catch (error) {
    console.error('Error exporting HTML:', error);
    Alert.alert('Error', 'Failed to export packing list');
  }
};

/**
 * Opens Amazon search for the given item with affiliate tracking ID
 * @param itemName - The name of the item to search for
 */
export const openAmazonSearch = (itemName: string) => {
  try {
    // Encode the item name for URL
    const encodedItemName = encodeURIComponent(itemName);
    // Add Amazon Associates tracking ID (affiliate tag)
    const affiliateTag = 'tripwiser-20';
    const amazonUrl = `https://www.amazon.com/s?k=${encodedItemName}&tag=${affiliateTag}`;
    // Open in browser
    Linking.openURL(amazonUrl);
  } catch (error) {
    console.error('Failed to open Amazon search:', error);
    Alert.alert('Error', 'Failed to open Amazon search');
  }
};

// Smart icon assignment based on category names (copied from PackingListScreen)
const getSmartIcon = (categoryName: string, customEmojis: Record<string, string> = {}): string => {
  if (customEmojis[categoryName]) {
    return customEmojis[categoryName];
  }
  const name = (categoryName || '').toLowerCase();
  if (name.includes('cloth') || name.includes('apparel') || name.includes('outfit')) return 'ğŸ‘•';
  if (name.includes('shoe') || name.includes('footwear')) return 'ğŸ‘Ÿ';
  if (name.includes('toiletries') || name.includes('hygiene') || name.includes('bathroom')) return 'ğŸ§´';
  if (name.includes('electronic') || name.includes('tech') || name.includes('gadget')) return 'ğŸ”Œ';
  if (name.includes('document') || name.includes('passport') || name.includes('id')) return 'ğŸ“„';
  if (name.includes('medication') || name.includes('medicine') || name.includes('health')) return 'ğŸ’Š';
  if (name.includes('food') || name.includes('snack') || name.includes('meal')) return 'ğŸ';
  if (name.includes('gift') || name.includes('souvenir')) return 'ğŸ';
  if (name.includes('work') || name.includes('business') || name.includes('office')) return 'ğŸ’¼';
  if (name.includes('camera') || name.includes('photo')) return 'ğŸ“·';
  if (name.includes('book') || name.includes('read')) return 'ğŸ“š';
  if (name.includes('sport') || name.includes('exercise') || name.includes('gym')) return 'âš½';
  if (name.includes('swim') || name.includes('beach') || name.includes('pool')) return 'ğŸŠâ€â™‚ï¸';
  if (name.includes('outdoor') || name.includes('camping') || name.includes('hiking')) return 'ğŸ•ï¸';
  if (name.includes('winter') || name.includes('cold') || name.includes('snow')) return 'â„ï¸';
  if (name.includes('formal') || name.includes('dress') || name.includes('suit')) return 'ğŸ¤µ';
  if (name.includes('accessory') || name.includes('jewelry')) return 'ğŸ’';
  if (name.includes('bag') || name.includes('luggage')) return 'ğŸ’';
  if (name.includes('convenience') || name.includes('comfort')) return 'ğŸ›‹ï¸';
  if (name.includes('weather') && name.includes('protection')) return 'â˜‚ï¸';
  if (name.includes('healthcare')) return 'ğŸ’Š';
  if (name.includes('documents') && name.includes('money')) return 'ğŸ“„';
  return 'ğŸ“¦';
};